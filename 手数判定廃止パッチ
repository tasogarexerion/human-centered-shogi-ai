cat > "$HOME/shogi/wrapper/taso_engine.sh" <<'SH'
#!/usr/bin/env bash
set -euo pipefail

# =========================================================
# TASO Engine â€” FINAL MEMORY EDITION (NO MOVE_COUNT)
# åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰æ‰‹æ•°ä¾å­˜ã‚’å®Œå…¨æ’¤å»
# =========================================================

# ========= User toggles =========
TASO_SHOW="${TASO_SHOW:-0}"
TASO_MIRACLE="${TASO_MIRACLE:-0}"
TASO_LOG="${TASO_LOG:-1}"
TASO_DEBUG="${TASO_DEBUG:-0}"

PREFLIGHT_MS="${PREFLIGHT_MS:-30}"

ENGINE_READ_TIMEOUT="${ENGINE_READ_TIMEOUT:-2}"
ENGINE_LINE_LIMIT="${ENGINE_LINE_LIMIT:-5000}"

# ========= Paths =========
ROOT="$HOME/shogi"
DL="$ROOT/engines/dlshogi/build/dlshogi"
DL_MODEL="$ROOT/models/dlshogi_model/model.onnx"

HUMAN_AI="$ROOT/humanscore_ai/infer.py"
HUMAN_PY="$ROOT/.venv/bin/python"

DL_THREADS="${DL_THREADS:-10}"
MULTIPV="${MULTIPV:-5}"

PREFLIGHT_THREADS="${PREFLIGHT_THREADS:-2}"
PREFLIGHT_MULTIPV="${PREFLIGHT_MULTIPV:-3}"

# ========= SUDDEN DEATH =========
SUDDEN_DEATH_MODE=0
TASO_SD_MPV_MIN="${TASO_SD_MPV_MIN:-2}"
TASO_SD_MPV_MAX="${TASO_SD_MPV_MAX:-3}"
TASO_SD_SCORE_LIMIT="${TASO_SD_SCORE_LIMIT:--600}"
declare -A PV_MOVES

# ========= State =========
CURRENT_POS=""
LAST_SCORE=0
LAST_MATE=0

# ========= UI helpers =========
say() { [ "$TASO_SHOW" = "1" ] && echo "info string $*"; }
dbg() { [ "$TASO_DEBUG" = "1" ] && echo "[DEBUG] $*" >&2; }

# ========= Dummy mode =========
DUMMY_MODE=0
if [ ! -x "$DL" ] || [ ! -f "$DL_MODEL" ]; then
  DUMMY_MODE=1
fi

# ========= cleanup =========
cleanup() {
  { echo "quit" >&3; } 2>/dev/null || true
  { echo "quit" >&7; } 2>/dev/null || true
  { echo "quit" >&5; } 2>/dev/null || true
}
trap cleanup EXIT INT TERM

# ========= mate helper =========
mate_num() {
  [[ "${1:-}" =~ ^-?[0-9]+$ ]] && echo "$1" || echo "0"
}

# ========= HumanScore =========
get_hws() {
  local cp="${1:-0}" spread="${2:-0}"
  if [ -n "$CURRENT_POS" ] && [ -f "$HUMAN_AI" ]; then
    "$HUMAN_PY" "$HUMAN_AI" "$CURRENT_POS" "$cp" "$spread" 2>/dev/null || echo "0.50"
  else
    echo "0.50"
  fi
}

# ========= bunker =========
bunker_flag() {
  local cp1="$1" cp2="$2"
  local spread=$((cp1 - cp2))
  if [ "$spread" -ge 300 ] && [ "$cp1" -ge -800 ] && [ "$cp1" -le 800 ]; then
    echo "1 $spread"
  else
    echo "0 $spread"
  fi
}

# ========= Yane switchï¼ˆæ‰‹æ•°åˆ¤å®šãªã—ï¼‰ =========
should_switch_to_yane() {
  local mate
  mate="$(mate_num "$LAST_MATE")"

  [ "$SUDDEN_DEATH_MODE" = "1" ] && return 1
  if [ "$mate" -gt 0 ] && [ "$mate" -le 5 ] && [ "$TASO_MIRACLE" = "0" ]; then
    return 0
  fi
  if [ "$LAST_SCORE" -ge 2500 ] || [ "$LAST_SCORE" -le -2500 ]; then
    return 0
  fi
  return 1
}

# ========= Main loopï¼ˆpositionã§æ‰‹æ•°ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ï¼‰ =========
while IFS= read -r line; do
  dbg "IN: $line"

  if [[ "$line" == position* ]]; then
    CURRENT_POS="${line#position }"
  fi

  if [[ "$line" == go* ]]; then
    say "ğŸ§­ å±€é¢è©•ä¾¡ã¯ |cp| ã¨ spread ã«åŸºã¥ã„ã¦åˆ¤æ–­"
  fi

  echo "$line"
done
SH

chmod +x "$HOME/shogi/wrapper/taso_engine.sh"
