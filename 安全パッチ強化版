#!/usr/bin/env bash
set -euo pipefail

# =========================================================
# TASO Engine â€” SAFETY HARDENED PATCH v1.1
# =========================================================

# ========= User toggles =========
TASO_SHOW="${TASO_SHOW:-0}"
TASO_MIRACLE="${TASO_MIRACLE:-0}"
TASO_LOG="${TASO_LOG:-1}"
TASO_DEBUG="${TASO_DEBUG:-0}"

PREFLIGHT_MS="${PREFLIGHT_MS:-30}"
ENGINE_READ_TIMEOUT="${ENGINE_READ_TIMEOUT:-2}"

# ========= Paths =========
DL="$HOME/shogi/engines/dlshogi/build/dlshogi"
DL_MODEL="$HOME/shogi/models/dlshogi_model/model.onnx"

# ========= State =========
CURRENT_POS=""
MOVE_COUNT=0
LAST_SCORE=0
LAST_MATE=0

# ========= UI =========
say() { [ "$TASO_SHOW" = "1" ] && echo "info string $*"; }
dbg() { [ "$TASO_DEBUG" = "1" ] && echo "[DEBUG] $*" >&2; }

# ========= Engine PIDs =========
DL_PID=""
PF_PID=""

# ========= Cleanup (NO kill 0) =========
cleanup() {
  dbg "cleanup start"
  [ -n "$DL_PID" ] && kill "$DL_PID" 2>/dev/null || true
  [ -n "$PF_PID" ] && kill "$PF_PID" 2>/dev/null || true
  dbg "cleanup done"
}
trap cleanup EXIT INT TERM

# ========= Dummy mode =========
DUMMY_MODE=0
if [ ! -x "$DL" ] || [ ! -f "$DL_MODEL" ]; then
  DUMMY_MODE=1
  dbg "dlshogi or model missing -> dummy mode"
fi

# ========= Start engines =========
if [ "$DUMMY_MODE" = "0" ]; then
  coproc DL_ENG { "$DL" --device metal --model "$DL_MODEL" --threads 8 --multipv 5; }
  DL_PID="$COPROC_PID"
  exec 3>&"${DL_ENG[1]}" 4<"${DL_ENG[0]}"

  coproc PF_ENG { "$DL" --device metal --model "$DL_MODEL" --threads 2 --multipv 3; }
  PF_PID="$COPROC_PID"
  exec 7>&"${PF_ENG[1]}" 8<"${PF_ENG[0]}"
else
  exec 3>/dev/null 4</dev/null
  exec 7>/dev/null 8</dev/null
fi

# ========= Helpers =========
read_until_token() {
  local fd="$1" token="$2" line
  while IFS= read -r -t "$ENGINE_READ_TIMEOUT" line <&"$fd"; do
    [[ "$line" == "$token"* ]] && return 0
  done
  return 1
}

mate_num() {
  [[ "$1" =~ ^-?[0-9]+$ ]] && echo "$1" || echo "0"
}

# ========= Main loop =========
while IFS= read -r line; do
  dbg "IN: $line"

  case "$line" in
    quit*)
      echo "quit" >&3 || true
      echo "quit" >&7 || true
      exit 0
      ;;
    usi*)
      if [ "$DUMMY_MODE" = "1" ]; then
        echo "id name TASO (dlshogi missing)"
        echo "id author TASO"
        echo "usiok"
      else
        echo "$line" >&3
        read_until_token 4 "usiok" || true
        echo "usiok"
      fi
      ;;
    isready*)
      if [ "$DUMMY_MODE" = "1" ]; then
        echo "readyok"
      else
        echo "$line" >&3
        read_until_token 4 "readyok" || true
        echo "readyok"
      fi
      ;;
    position*)
      CURRENT_POS="${line#position }"
      MOVE_COUNT="$(echo "$line" | awk '{for(i=1;i<=NF;i++)if($i=="moves"){print NF-i;exit}print 0}')"
      [ "$DUMMY_MODE" = "0" ] && echo "$line" >&3
      ;;
    go*)
      if [ "$DUMMY_MODE" = "1" ]; then
        say "âŒ dlshogi/model.onnx not found"
        echo "bestmove resign"
        continue
      fi

      say "ðŸ§  TASO thinking..."
      echo "$line" >&3

      FOUND=0
      while IFS= read -r -t "$ENGINE_READ_TIMEOUT" out <&4; do
        dbg "ENG: $out"
        echo "$out"
        if [[ "$out" == bestmove* ]]; then
          FOUND=1
          break
        fi
      done

      if [ "$FOUND" = "0" ]; then
        say "âš  engine timeout â†’ emergency resign"
        echo "bestmove resign"
      fi
      ;;
    *)
      [ "$DUMMY_MODE" = "0" ] && echo "$line" >&3
      ;;
  esac
done
